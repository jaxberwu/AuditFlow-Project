# æ•°æ®å­˜å‚¨æ¶æ„è¯´æ˜

## ğŸ“Š æ•°æ®å­˜å‚¨ä½ç½®

### æ•°æ®åº“ä¿¡æ¯
- **æ•°æ®åº“ç±»å‹**: SQL Server LocalDB
- **æ•°æ®åº“åç§°**: `AuditFlowDB`
- **è¿æ¥å­—ç¬¦ä¸²**: `Server=(localdb)\mssqllocaldb;Database=AuditFlowDB;Trusted_Connection=True`
- **æ•°æ®åº“æ–‡ä»¶ä½ç½®**: 
  - Windows: `C:\Users\{ç”¨æˆ·å}\AuditFlowDB.mdf`
  - æˆ–é€šè¿‡ SQL Server Management Studio æŸ¥çœ‹

### æ•°æ®è¡¨ç»“æ„

#### 1. HardwareAssets (ç¡¬ä»¶èµ„äº§è¡¨)
```sql
CREATE TABLE HardwareAssets (
    SN NVARCHAR(100) PRIMARY KEY,      -- åºåˆ—å·ï¼ˆä¸»é”®ï¼‰
    Hostname NVARCHAR(200),            -- ä¸»æœºå
    PurchaseDate DATETIME2,            -- è´­ä¹°æ—¥æœŸ
    Status NVARCHAR(50)                -- çŠ¶æ€
)
```

**ç§å­æ•°æ®** (åœ¨ `AuditFlow.Engine/Program.cs` ä¸­åˆå§‹åŒ–):
- SN001: DEVICE-OLD-01 (2018-01-15)
- SN002: DEVICE-OLD-02 (2018-06-20)
- SN003: DEVICE-OLD-03 (2018-11-10)
- SN004: DEVICE-NEW-01 (2024-03-05)
- SN005: DEVICE-NEW-02 (2024-08-12)

#### 2. ThreatAlerts (å¨èƒè­¦æŠ¥è¡¨)
```sql
CREATE TABLE ThreatAlerts (
    Id INT PRIMARY KEY IDENTITY(1,1),  -- è‡ªå¢ID
    SN NVARCHAR(100),                  -- åºåˆ—å·ï¼ˆå…³è”ç¡¬ä»¶èµ„äº§ï¼‰
    Severity NVARCHAR(50) DEFAULT 'Critical'  -- å¨èƒä¸¥é‡ç¨‹åº¦
)
```

**ç§å­æ•°æ®** (åœ¨ `AuditFlow.Simulator/Program.cs` ä¸­åˆå§‹åŒ–):
- SN001: Critical
- SN002: High
- SN003: Critical

---

## ğŸ”„ æ•°æ®æµç¨‹

### 1. æ•°æ®åº“åˆå§‹åŒ–
å½“æœåŠ¡å¯åŠ¨æ—¶ï¼ŒEF Core ä¼šè‡ªåŠ¨ï¼š

```csharp
// åœ¨ AuditFlow.Simulator/Program.cs å’Œ AuditFlow.Engine/Program.cs ä¸­
db.Database.EnsureCreated();  // å¦‚æœæ•°æ®åº“ä¸å­˜åœ¨ï¼Œè‡ªåŠ¨åˆ›å»º
```

### 2. æ•°æ®ç§å­ (Seed Data)

#### Simulator æœåŠ¡ (Port 5001)
- **èŒè´£**: æ¨¡æ‹Ÿå¨èƒæ•°æ®æä¾›è€…ï¼ˆå°†æ¥æ›¿æ¢ä¸º CrowdStrike APIï¼‰
- **åˆå§‹åŒ–**: åœ¨ `Program.cs` ç¬¬ 42-51 è¡Œ
- **æ•°æ®**: æ’å…¥ 3 æ¡å¨èƒè®°å½•åˆ° `ThreatAlerts` è¡¨

#### Engine æœåŠ¡ (Port 5002)
- **èŒè´£**: å®¡è®¡å¼•æ“ï¼Œå­˜å‚¨ç¡¬ä»¶èµ„äº§æ•°æ®
- **åˆå§‹åŒ–**: åœ¨ `Program.cs` ç¬¬ 50-64 è¡Œ
- **æ•°æ®**: æ’å…¥ 5 æ¡ç¡¬ä»¶èµ„äº§è®°å½•åˆ° `HardwareAssets` è¡¨

### 3. æ•°æ®è®¿é—®æµç¨‹

```
å‰ç«¯ (React) 
    â†“ HTTP GET
Engine API (Port 5002) 
    â†“ 1. HTTP GET è°ƒç”¨ Simulator
    â†“ 2. ä»æ•°æ®åº“è¯»å– HardwareAssets
Simulator API (Port 5001)
    â†“ ä»æ•°æ®åº“è¯»å– ThreatAlerts
SQL Server LocalDB (AuditFlowDB)
```

### 4. å®¡è®¡é€»è¾‘æ‰§è¡Œ

åœ¨ `AuditFlow.Engine/Program.cs` çš„ `/audit/summary` ç«¯ç‚¹ï¼š

1. **è·å–å¨èƒæ•°æ®**: 
   ```csharp
   var httpClient = httpClientFactory.CreateClient("Simulator");
   var threats = await httpClient.GetFromJsonAsync<List<ThreatAlert>>("/threats");
   ```

2. **è·å–ç¡¬ä»¶èµ„äº§**:
   ```csharp
   var assets = await db.HardwareAssets.ToListAsync();
   ```

3. **åŒ¹é…å’Œè®¡ç®—**:
   ```csharp
   // å®¡è®¡è§„åˆ™: è®¾å¤‡å¹´é¾„ >= 5å¹´ AND æœ‰å¨èƒ = éœ€è¦æ›´æ¢
   var replacementRequired = assets
       .Where(asset => {
           var ageYears = currentYear - asset.PurchaseDate.Year;
           var hasThreat = threats.Any(t => t.SN == asset.SN);
           return ageYears >= 5 && hasThreat;
       })
   ```

---

## ğŸ—„ï¸ æ•°æ®åº“è®¿é—®æ–¹å¼

### ä½¿ç”¨ Entity Framework Core

**DbContext**: `AuditFlow.Shared.Data.AuditFlowDbContext`

```csharp
public class AuditFlowDbContext : DbContext
{
    public DbSet<HardwareAsset> HardwareAssets { get; set; }
    public DbSet<ThreatAlert> ThreatAlerts { get; set; }
}
```

### é…ç½®ä½ç½®

**è¿æ¥å­—ç¬¦ä¸²é…ç½®**:
- `AuditFlow.Simulator/appsettings.json`
- `AuditFlow.Engine/appsettings.json`

```json
{
  "ConnectionStrings": {
    "DefaultConnection": "Server=(localdb)\\mssqllocaldb;Database=AuditFlowDB;Trusted_Connection=True;MultipleActiveResultSets=true"
  }
}
```

---

## ğŸ” å¦‚ä½•æŸ¥çœ‹æ•°æ®åº“

### æ–¹æ³• 1: SQL Server Management Studio (SSMS)
1. æ‰“å¼€ SSMS
2. è¿æ¥åˆ°: `(localdb)\mssqllocaldb`
3. å±•å¼€æ•°æ®åº“ â†’ `AuditFlowDB`
4. æŸ¥çœ‹è¡¨: `HardwareAssets` å’Œ `ThreatAlerts`

### æ–¹æ³• 2: Visual Studio
1. æ‰“å¼€ "SQL Server Object Explorer"
2. è¿æ¥åˆ° `(localdb)\mssqllocaldb`
3. æŸ¥çœ‹ `AuditFlowDB` æ•°æ®åº“

### æ–¹æ³• 3: å‘½ä»¤è¡Œ (sqlcmd)
```bash
sqlcmd -S "(localdb)\mssqllocaldb" -d AuditFlowDB
SELECT * FROM HardwareAssets;
SELECT * FROM ThreatAlerts;
GO
```

---

## ğŸ“ æ•°æ®æŒä¹…åŒ–

### å½“å‰å®ç°
- âœ… æ•°æ®å­˜å‚¨åœ¨ SQL Server LocalDBï¼ˆæœ¬åœ°æ•°æ®åº“æ–‡ä»¶ï¼‰
- âœ… æœåŠ¡é‡å¯åæ•°æ®ä»ç„¶å­˜åœ¨
- âœ… ä¸¤ä¸ªæœåŠ¡å…±äº«åŒä¸€ä¸ªæ•°æ®åº“

### æ•°æ®ç”Ÿå‘½å‘¨æœŸ
1. **é¦–æ¬¡å¯åŠ¨**: æ•°æ®åº“è‡ªåŠ¨åˆ›å»ºï¼Œç§å­æ•°æ®è‡ªåŠ¨æ’å…¥
2. **åç»­å¯åŠ¨**: å¦‚æœæ•°æ®å·²å­˜åœ¨ï¼Œä¸ä¼šé‡å¤æ’å…¥ï¼ˆé€šè¿‡ `if (!db.ThreatAlerts.Any())` æ£€æŸ¥ï¼‰
3. **æ•°æ®ä¿®æ”¹**: éœ€è¦æ‰‹åŠ¨æ›´æ–°æ•°æ®åº“æˆ–é€šè¿‡ API ç«¯ç‚¹

---

## ğŸ”® æœªæ¥é›†æˆ CrowdStrike API

### å½“å‰æ¶æ„ï¼ˆæ¨¡æ‹Ÿï¼‰
```
Simulator â†’ ä»æ•°æ®åº“è¯»å–å¨èƒæ•°æ® â†’ è¿”å› JSON
```

### å°†æ¥æ¶æ„ï¼ˆçœŸå®ï¼‰
```
Simulator â†’ è°ƒç”¨ CrowdStrike API â†’ è·å–å®æ—¶å¨èƒæ•°æ® â†’ è¿”å› JSON
```

**ä¿®æ”¹ä½ç½®**: `AuditFlow.Simulator/Program.cs` çš„ `/threats` ç«¯ç‚¹

```csharp
// å°†æ¥æ›¿æ¢ä¸º:
app.MapGet("/threats", async () => {
    // è°ƒç”¨ CrowdStrike API
    var crowdStrikeClient = new CrowdStrikeApiClient();
    var threats = await crowdStrikeClient.GetThreatsAsync();
    return Results.Ok(threats);
});
```

---

## ğŸ“‹ æ•°æ®æ¨¡å‹å®šä¹‰

### å®ä½“ç±»ä½ç½®
- `AuditFlow.Shared/Entities/HardwareAsset.cs`
- `AuditFlow.Shared/Entities/ThreatAlert.cs`

### DTO ä½ç½®
- `AuditFlow.Shared/DTOs/AuditSummaryDto.cs`

---

## ğŸ¯ å…³é”®ç‚¹æ€»ç»“

1. **å…±äº«æ•°æ®åº“**: Simulator å’Œ Engine ä½¿ç”¨åŒä¸€ä¸ª `AuditFlowDB` æ•°æ®åº“
2. **è‡ªåŠ¨åˆå§‹åŒ–**: æœåŠ¡å¯åŠ¨æ—¶è‡ªåŠ¨åˆ›å»ºæ•°æ®åº“å’Œè¡¨ç»“æ„
3. **ç§å­æ•°æ®**: é¦–æ¬¡å¯åŠ¨æ—¶è‡ªåŠ¨æ’å…¥æµ‹è¯•æ•°æ®
4. **æ•°æ®åˆ†ç¦»**: 
   - Simulator ç®¡ç†å¨èƒæ•°æ®ï¼ˆThreatAlertsï¼‰
   - Engine ç®¡ç†ç¡¬ä»¶èµ„äº§æ•°æ®ï¼ˆHardwareAssetsï¼‰
5. **API é€šä¿¡**: Engine é€šè¿‡ HTTP è°ƒç”¨ Simulator è·å–å¨èƒæ•°æ®ï¼Œè€Œä¸æ˜¯ç›´æ¥è®¿é—®æ•°æ®åº“

---

**æœ€åæ›´æ–°**: 2026-01-20
